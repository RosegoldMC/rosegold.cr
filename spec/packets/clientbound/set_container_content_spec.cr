require "../../spec_helper"

Spectator.describe Rosegold::Clientbound::SetContainerContent do
  it "uses correct packet ID for protocol 772" do
    expect(Rosegold::Clientbound::SetContainerContent[772_u32]).to eq(0x12_u8)
  end

  it "supports protocol 772 only" do
    expect(Rosegold::Clientbound::SetContainerContent.supports_protocol?(772_u32)).to be_true
    expect(Rosegold::Clientbound::SetContainerContent.supports_protocol?(999_u32)).to be_false
  end

  describe "EOF error packet analysis" do
    let(:failing_packet_hex) { "12002e2e0000000000019d0707000d02011b66696e616c653a61726d6f725f746f7567686e6573735f686561644000000000000000000700001166696e616c653a61726d6f725f6865616440080000000000000007000a04000127031b041e0308010a0100066974616c696300080005636f6c6f720005776869746509000565787472610a00000001080005636f6c6f720004676f6c6408000474657874000a6772657073656461776b00080004746578740018546869732061726d6f7220697320626f756e6420746f3a200010010302050a09000565787472610a000000010100066974616c69630001000a756e6465726c696e656400010004626f6c6400080005636f6c6f720004626c756501000a6f6266757363617465640001000d737472696b657468726f75676800080004746578740007476f6470726f740008000474657874000000000a0a00125075626c696342756b6b697456616c75657308002073696d706c6561646d696e6861636b733a7361685f61726d6f7572626f756e64002430313131623935642d313130632d346561312d623462322d3539616665666632393666340000019e0707000d02011c66696e616c653a61726d6f725f746f7567686e6573735f63686573744000000000000000000600001266696e616c653a61726d6f725f636865737440200000000000000006000a0227031b0408010a0100066974616c696300080005636f6c6f720005776869746509000565787472610a00000001080005636f6c6f720004676f6c6408000474657874000a6772657073656461776b00080004746578740018546869732061726d6f7220697320626f756e6420746f3a200010010302050a09000565787472610a000000010100066974616c69630001000a756e6465726c696e656400010004626f6c6400080005636f6c6f720004626c756501000a6f6266757363617465640001000d737472696b657468726f75676800080004746578740007476f6470726f740008000474657874000000000a0a00125075626c696342756b6b697456616c75657308002073696d706c6561646d696e6861636b733a7361685f61726d6f7572626f756e64002430313131623935642d313130632d346561312d623462322d3539616665666632393666340000019f0707000d02011b66696e616c653a61726d6f725f746f7567686e6573735f6c6567734000000000000000000500001166696e616c653a61726d6f725f6c65677340180000000000000005000a0227031b0408010a0100066974616c696300080005636f6c6f720005776869746509000565787472610a00000001080005636f6c6f720004676f6c6408000474657874000a6772657073656461776b00080004746578740018546869732061726d6f7220697320626f756e6420746f3a200010010301050a09000565787472610a000000010100066974616c69630001000a756e6465726c696e656400010004626f6c6400080005636f6c6f720004626c756501000a6f6266757363617465640001000d737472696b657468726f75676800080004746578740007476f6470726f740008000474657874000000000a0a00125075626c696342756b6b697456616c75657308002073696d706c6561646d696e6861636b733a7361685f61726d6f7572626f756e64002430313131623935642d313130632d346561312d623462322d353961666566663239366634000001a00707000d02011b66696e616c653a61726d6f725f746f7567686e6573735f666565744000000000000000000400001166696e616c653a61726d6f725f6665657440080000000000000004000a0427031b040904070308010a0100066974616c696300080005636f6c6f720005776869746509000565787472610a00000001080005636f6c6f720004676f6c6408000474657874000a6772657073656461776b00080004746578740018546869732061726d6f7220697320626f756e6420746f3a200010010301050a09000565787472610a000000010100066974616c69630001000a756e6465726c696e656400010004626f6c6400080005636f6c6f720004626c756501000a6f6266757363617465640001000d737472696b657468726f75676800080004746578740007476f6470726f740008000474657874000000000a0a00125075626c696342756b6b697456616c75657308002073696d706c6561646d696e6861636b733a7361685f61726d6f7572626f756e64002430313131623935642d313130632d346561312d623462322d353961666566663239366634000000000000000000000000000000000000000000000000000000000001820704000380010a0327030d0308040d02041366696e616c653a61747461636b5f7370656564bff0000000000000000100021466696e616c653a61747461636b5f64616d6167654014000000000000000100100110c707000010c707000010c707000010c707000010c707000010c707000004c7070000018107030003d9030a0327030d03080410070000" }
    let(:packet_bytes) { Bytes.new(failing_packet_hex.size // 2) { |i| failing_packet_hex[i * 2, 2].to_u8(16) } }
    let(:io) { Minecraft::IO::Memory.new(packet_bytes) }

    it "is able to read" do
      io.read_byte # Skip packet ID (0x12)

      expect { Rosegold::Clientbound::SetContainerContent.read(io) }.not_to raise_error
    end

    it "contains the right container data" do
      io.read_byte # Skip packet ID (0x12)
      container = Rosegold::Clientbound::SetContainerContent.read(io)

      expect(container.window_id).to eq(0_u8)
      expect(container.state_id).to eq(46_u32)
      # Packet is truncated, so we expect fewer slots than the declared 46
      expect(container.slots.size).to eq(7)
      expect(container.slots.size).to be < 46
    end
  end
end
